{% extends 'base.html' %}
{% load static %}

{% block title %}Catchment Simulations{% endblock %}

{% block head_scripts %}
{% include 'main/_chart_scripts.html' %}
{% endblock %}

{% block style %}
{% include 'main/_upload_zone_styles.html' %}
{% endblock %}

{% block additional_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var optionSelect = document.getElementById('id_option');
    var predefinedMethods = [
        'simulate_n_imperv', 'simulate_n_perv',
        'simulate_s_imperv', 'simulate_s_perv'
    ];

    function toggleRangeFields() {
        var isPredefined = predefinedMethods.indexOf(optionSelect.value) !== -1;
        var fieldIds = ['id_start', 'id_stop', 'id_step'];
        fieldIds.forEach(function(fieldId) {
            var field = document.getElementById(fieldId);
            if (field) {
                var wrapper = field.closest('.col-md-2');
                if (wrapper) {
                    wrapper.style.display = isPredefined ? 'none' : '';
                }
            }
        });
    }

    if (optionSelect) {
        optionSelect.addEventListener('change', toggleRangeFields);
        toggleRangeFields();
    }

    var configEl = document.getElementById('chart-config');
    if (configEl) {
        try {
            var config = JSON.parse(configEl.textContent);
            renderLineChart('simulation-chart', config.data, config.x, config.y, {title: config.title});
        } catch (e) {
            console.error('Failed to render chart:', e);
            var el = document.getElementById('simulation-chart');
            if (el) el.innerHTML = '<p class="text-danger text-center">Failed to load chart.</p>';
        }
    }
});
</script>
{% endblock %}

{% block content %}

{% include 'main/_upload_zone.html' %}

{% load crispy_forms_tags %}

<form method="post">
    {% csrf_token %}
        <div class="container">
            <div class="row d-flex justify-content-center">
                <div class="col-md-2">
                    {{ form.option|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    {{ form.start|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    {{ form.stop|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    {{ form.step|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    {{ form.catchment_name|as_crispy_field }}
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12 d-flex justify-content-center">
                <button type="submit" class="btn btn-primary" id="run-simulation-button" data-authenticated="{{ request.user.is_authenticated }}">Run Simulation</button>
            </div>
        </div>


        {% if show_download_button %}
        <div id="simulation-chart"><p class="text-muted text-center">Loading chart...</p></div>
        {{ chart_config|json_script:"chart-config" }}

        {% if output_file_url %}
        <div class="row mt-3">
            <div class="col-md-12 d-flex justify-content-center">
                <a href="{{ output_file_url }}" download="{{ output_file_name }}" class="btn btn-success">Download Results</a>
            </div>
        </div>
        {% endif %}

        <div class="row mt-3">
            <div class="col-md-12">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th class="text-center">Index</th>
                            {% for col in results_columns %}
                            <th class="text-center">{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in results_data %}
                            <tr>
                                <td class="text-center">{{ forloop.counter }}</td>
                                {% for val in row %}
                                <td class="text-center">{{ val|floatformat:2 }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
</form>

{% endblock %}
